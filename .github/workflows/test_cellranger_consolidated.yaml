name: Test Cell Ranger Versions

on:
  push:
    branches: [ main ]
    paths:
      - 'dockerhub_repos/cellranger/*/Dockerfile'
  pull_request:
    branches: [ main ]
    paths:
      - 'dockerhub_repos/cellranger/*/Dockerfile'

jobs:
  test_cellranger:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        version: 
          - '7.1.0'
          - '7.2.0'
          - '8.0.0'
          - '8.0.1'
          - '9.0.0'
          - '9.0.1'
          - '10.0.0'
      fail-fast: false  # Continue testing other versions even if one fails
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Pull Docker image
      run: docker pull ccrsfifx/cellranger:${{ matrix.version }}
      
    - name: Run container and check cellranger version
      run: docker run --rm ccrsfifx/cellranger:${{ matrix.version }} cellranger --version

    - name: Validate version consistency
      run: |
        # Extract the full version output from 'cellranger --version'
        CELLRANGER_OUTPUT=$(docker run --rm ccrsfifx/cellranger:${{ matrix.version }} cellranger --version)
        
        # Expected version formats (v10+ uses space, older versions use hyphen)
        EXPECTED_VERSION_HYPHEN="cellranger-${{ matrix.version }}"
        EXPECTED_VERSION_SPACE="cellranger ${{ matrix.version }}"
        
        # Check if either format matches
        if [[ "$CELLRANGER_OUTPUT" == *"$EXPECTED_VERSION_HYPHEN"* ]] || [[ "$CELLRANGER_OUTPUT" == *"$EXPECTED_VERSION_SPACE"* ]]; then
          echo "âœ“ Cell Ranger version matches expected version: ${{ matrix.version }}"
          echo "  Output: $CELLRANGER_OUTPUT"
        else
          echo "Error: Cell Ranger version doesn't match expected version ${{ matrix.version }}"
          echo "  Got: $CELLRANGER_OUTPUT"
          exit 1
        fi
